<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrath Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background */
            color: #e0e0e0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #2a003f; /* Darker purple */
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            max-width: 700px;
            width: 100%;
            text-align: center;
        }
        .title {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            color: #d1b0ff; /* Light purple */
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(209, 176, 255, 0.6);
        }
        .description {
            font-size: 1rem; /* text-base */
            color: #b0a0d0; /* Muted purple */
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #d1b0ff;
        }
        .input-group textarea,
        .input-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #4a005f;
            background-color: #0d0d1a;
            color: #e0e0e0;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box; /* Ensures padding is included in the width */
        }
        .input-group input[type="text"] {
            min-height: auto;
            height: auto;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .image-container {
            min-height: 300px; /* Minimum height for image area */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0d0d1a; /* Even darker background for image */
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        .generated-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            object-fit: contain;
            display: none; /* Hidden until loaded */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #d1b0ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .generate-button, .reset-button {
            background-image: linear-gradient(to right, #6a0578 0%, #8c00b0 50%, #6a0578 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            background-size: 200% auto;
        }
        .reset-button {
            background-image: linear-gradient(to right, #4b0060 0%, #6a0578 50%, #4b0060 100%);
        }
        .generate-button:hover, .reset-button:hover {
            background-position: right center; /* change the direction of the change here */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
            transform: translateY(-2px);
        }
        .generate-button:active, .reset-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .message-box {
            background-color: #4a005f;
            color: #d1b0ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Сгенерировать изображение</h1>
        <p class="description">
            Введите промпт и API ключ ниже, затем нажмите "Сгенерировать изображение".
            Нажмите "Сбросить промпт", чтобы восстановить промпт по умолчанию.
        </p>

        <div class="input-group">
            <label for="promptInput">Промпт для генерации изображения:</label>
            <textarea id="promptInput" rows="7"></textarea>
            <div class="button-group">
                <button id="resetPromptButton" class="reset-button">Сбросить промпт</button>
            </div>
        </div>

        <div class="input-group">
            <label for="apiKeyInput">Ваш API ключ:</label>
            <input type="text" id="apiKeyInput" placeholder="Введите ваш API ключ здесь">
        </div>
        
        <div class="image-container" id="imageContainer">
            <div id="loadingSpinner" class="loading-spinner"></div>
            <img id="generatedImage" class="generated-image" alt="Generated image of Agrath">
        </div>
        <button id="generateButton" class="generate-button">Сгенерировать изображение</button>
        <div id="messageBox" class="message-box"></div>
    </div>

    <script type="module">
        const generateButton = document.getElementById('generateButton');
        const resetPromptButton = document.getElementById('resetPromptButton');
        const generatedImage = document.getElementById('generatedImage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const imageContainer = document.getElementById('imageContainer');
        const messageBox = document.getElementById('messageBox');
        const promptInput = document.getElementById('promptInput');
        const apiKeyInput = document.getElementById('apiKeyInput');

        // Default prompt for Agrath's human form
        const defaultAgrathPrompt = `
            A tall male human, appearing like an Italian or a Spaniard.
            He has short, straight black locks of hair.
            His eyes are brown, almost amber, with a cut that makes them seem slightly squinted and sly.
            He has sensual lips.
            He can summon dark, viscous tentacles from his limbs or transform his fingers into them.
            The setting should be subtle and unassuming, blending into an ordinary human environment.
            Focus on his human features, with a hint of something unusual or unsettling in his expression.
            High detail, realistic, portrait, dark fantasy.
        `;

        // Set the default prompt when the page loads
        promptInput.value = defaultAgrathPrompt.trim();

        // Function to display messages
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'error') {
                messageBox.style.backgroundColor = '#880000';
                messageBox.style.color = '#ffcccc';
            } else {
                messageBox.style.backgroundColor = '#4a005f';
                messageBox.style.color = '#d1b0ff';
            }
        }

        // Event listener for the generate button
        generateButton.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            const apiKey = apiKeyInput.value.trim(); // Get API key from input, if provided

            if (!prompt) {
                showMessage("Пожалуйста, введите промпт для генерации изображения.", "error");
                return;
            }

            generatedImage.style.display = 'none'; // Hide image
            loadingSpinner.style.display = 'block'; // Show spinner
            generateButton.disabled = true; // Disable button
            resetPromptButton.disabled = true; // Disable reset button
            messageBox.style.display = 'none'; // Hide any previous messages

            try {
                // Use the user-provided API key, or fallback to the empty string for Canvas runtime
                const effectiveApiKey = apiKey === "" ? "" : apiKey;
                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${effectiveApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    generatedImage.src = imageUrl;
                    generatedImage.onload = () => {
                        loadingSpinner.style.display = 'none';
                        generatedImage.style.display = 'block';
                        generateButton.disabled = false;
                        resetPromptButton.disabled = false;
                        showMessage("Изображение успешно сгенерировано!", "success");
                    };
                    generatedImage.onerror = () => {
                        loadingSpinner.style.display = 'none';
                        generateButton.disabled = false;
                        resetPromptButton.disabled = false;
                        showMessage("Не удалось загрузить изображение. Попробуйте еще раз.", "error");
                    };
                } else {
                    loadingSpinner.style.display = 'none';
                    generateButton.disabled = false;
                    resetPromptButton.disabled = false;
                    showMessage("Не удалось сгенерировать изображение. Пожалуйста, попробуйте еще раз. Возможно, API ключ недействителен или проблема с запросом.", "error");
                    console.error('Image generation failed:', result);
                }
            } catch (error) {
                loadingSpinner.style.display = 'none';
                generateButton.disabled = false;
                resetPromptButton.disabled = false;
                showMessage("Произошла ошибка при генерации изображения. Пожалуйста, проверьте подключение к Интернету или API ключ.", "error");
                console.error('Error generating image:', error);
            }
        });

        // Event listener for the reset prompt button
        resetPromptButton.addEventListener('click', () => {
            promptInput.value = defaultAgrathPrompt.trim();
            showMessage("Промпт сброшен до значения по умолчанию.", "info");
        });
    </script>
</body>
</html>
